<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Centre de Contr√¥le - Temple de Jeanne</title>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root{ --beige:#efe6d8; --accent:#a67c52; --frame:#7a5234; --panel:#f8f3ee; --muted:#5b4a3f; --shadow:0 6px 18px rgba(0,0,0,.12); --today:#c79a6d; --todayText:#2d1f16; --green:#3b7f3b; --bordeaux:#8B0000; --blue:#2563eb; --yellow:#eab308; }
    *{box-sizing:border-box}
    body{font-family:'Cinzel', Georgia, serif;background:linear-gradient(180deg,var(--beige),#f7f1e6);margin:0;padding:0;color:var(--muted);overflow-x:hidden}
    
    /* ANIMATION STAR WARS */
    #starwars-intro{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;perspective:800px}
    #starwars-intro.hidden{display:none}
    .starwars-text{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:100%;text-align:center;color:#feda4a;font-family:'Orbitron',sans-serif;font-size:32px;font-weight:700;animation:crawlReverse 6s ease-out forwards;opacity:0;line-height:1.6}
@keyframes crawlReverse{
  0%{transform:translate(-50%,-50%) perspective(400px) rotateX(60deg) translateZ(-800px) scale(0.1);opacity:0}
  15%{opacity:1}
  85%{opacity:1;transform:translate(-50%,-50%) perspective(400px) rotateX(20deg) translateZ(-100px) scale(1)}
  100%{transform:translate(-50%,-50%) perspective(400px) rotateX(0deg) translateZ(0px) scale(1.3);opacity:1}
}
.skip-button{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);padding:14px 28px;background:rgba(254,218,74,0.15);border:3px solid #feda4a;color:#feda4a;border-radius:10px;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:18px;font-weight:700;transition:all 0.3s;animation:fadeInButton 1s ease-in-out 2s forwards;opacity:0;box-shadow:0 0 20px rgba(254,218,74,0.3)}
.skip-button:hover{background:#feda4a;color:#000;transform:translateX(-50%) scale(1.1);box-shadow:0 0 30px rgba(254,218,74,0.8)}
@keyframes fadeInButton{to{opacity:1}}
    
    .wrap{max-width:1400px;margin:0 auto;padding:24px;display:grid;grid-template-columns:1fr minmax(280px,22%);gap:20px}
    header{grid-column:1/-1;background:linear-gradient(135deg,#1e3a8a,#3b82f6);border:4px solid var(--blue);border-radius:14px;padding:20px 24px;box-shadow:0 8px 24px rgba(37,99,235,0.3);display:flex;align-items:center;gap:18px;flex-wrap:wrap;color:#fff}
    .header-title{flex:1 1 auto;min-width:0}
    .header-actions{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .logo{width:90px;height:90px;border-radius:12px;border:3px solid #feda4a;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#1e3a8a,#3b82f6);box-shadow:0 0 20px rgba(254,218,74,0.5)}
    .logo h1{margin:0;font-size:28px;color:#feda4a;font-family:'Orbitron',sans-serif;text-shadow:0 0 10px rgba(254,218,74,0.8)}
    header h2{margin:0;font-size:36px;color:#feda4a;font-family:'Orbitron',sans-serif;text-shadow:0 0 15px rgba(254,218,74,0.6);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .realtime-info{display:flex;gap:16px;font-size:14px;color:#e0e7ff;font-family:'Orbitron',sans-serif}
    .realtime-info span{background:rgba(255,255,255,0.1);padding:6px 12px;border-radius:8px;border:1px solid rgba(254,218,74,0.3)}
    .card{background:var(--panel);border:3px solid rgba(122,82,52,0.18);padding:14px;border-radius:10px;box-shadow:var(--shadow)}
    .frame{position:relative;border:3px double var(--frame);padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),transparent);box-shadow:0 0 0 1px rgba(176,141,87,.35) inset}
    .edit-guard{position:relative}
    .overlay{position:absolute;inset:0;background:rgba(255,255,255,.7);display:flex;align-items:center;justify-content:center;border-radius:10px;z-index:10}
    .hidden{display:none}
    .main{display:flex;flex-direction:column;gap:12px}
    .collapsible-header{display:flex;align-items:center;justify-content:space-between;gap:8px;cursor:pointer;padding:8px 12px;border-radius:8px;background:rgba(166,124,82,.06);user-select:none;transition:all 0.2s}
    .collapsible-header:hover{background:rgba(166,124,82,.12)}
    .collapsible-body{margin-top:8px}
    .controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    input[type=date], input[type=text], textarea, select{padding:8px;border-radius:6px;border:1px solid #d6c8b4;background:#fff;width:100%;font-family:'Cinzel',Georgia,serif}
    button{background:var(--accent);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s;font-family:'Cinzel',Georgia,serif}
    button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(166,124,82,0.3)}
    button.secondary{background:transparent;border:2px solid var(--accent);color:var(--accent)}
    button.small{padding:6px 10px;font-size:12px}
    button[disabled]{opacity:.6;cursor:not-allowed;transform:none}
    
    /* CHECK-LISTES */
    .checklist-section{border:3px solid var(--blue);border-radius:12px;padding:16px;margin-bottom:12px;background:linear-gradient(135deg,#eff6ff,#dbeafe)}
    .checklist-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--blue)}
    .checklist-title{font-size:20px;font-weight:700;color:var(--blue);display:flex;align-items:center;gap:8px}
    .checklist-progress{font-size:16px;color:var(--blue);font-weight:600}
    .checklist-item{display:flex;align-items:flex-start;gap:10px;padding:8px;margin:6px 0;background:#fff;border-radius:8px;border:2px solid #e5e7eb;transition:all 0.2s}
    .checklist-item:hover{border-color:var(--blue);box-shadow:0 2px 8px rgba(37,99,235,0.1)}
    .checklist-item input[type=checkbox]{width:20px;height:20px;cursor:pointer;margin-top:2px}
    .checklist-item.checked{background:#f0fdf4;border-color:var(--green)}
    .checklist-item.checked label{text-decoration:line-through;color:#6b7280}
    .checklist-item label{flex:1;cursor:pointer;font-size:14px;line-height:1.5}
    .checklist-meta{font-size:11px;color:#6b7280;margin-top:4px}
    
    /* INFOS IMPORTANTES */
    .important-info{border:4px solid #dc2626;border-radius:12px;padding:16px;background:linear-gradient(135deg,#fef2f2,#fee2e2);margin-bottom:16px}
    .important-info h3{margin:0 0 10px 0;color:#dc2626;font-size:20px;display:flex;align-items:center;gap:8px}
    .important-info textarea{border:2px solid #dc2626;min-height:100px;font-family:'Cinzel',Georgia,serif;resize:vertical}
    .info-history{margin-top:12px;padding:10px;background:#fff;border-radius:8px;border:2px solid #fecaca;max-height:200px;overflow-y:auto}
    .info-entry{padding:8px;margin:4px 0;background:#fef2f2;border-left:4px solid #dc2626;border-radius:4px;font-size:13px}
    .info-entry small{color:#991b1b;display:block;margin-top:4px}
    
    .day-list{max-height:520px;overflow:auto}
    .entry{border-left:6px solid var(--green);padding:12px 14px;margin-bottom:12px;background:linear-gradient(180deg,#fffef0,#fff5b8);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .entry.done{opacity:.85}
    .entry.done strong,.entry.done small{text-decoration:line-through}
    .entry .row{display:flex;align-items:center;gap:10px}
    .entry small{display:block;color:#6b5b4e;margin-top:4px}
    .entry strong{color:var(--bordeaux)}
    .entry .meta{font-size:11px;color:#8b7a6a;margin-top:4px}
    .badge-pill{display:inline-block;padding:4px 8px;border-radius:999px;border:1px solid var(--frame);background:#fff;font-size:12px}
    .month-strip{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;font-size:12px}
    .weekday{font-weight:700;text-align:center;color:#7a6a5a}
    .day-box{padding:6px;border-radius:10px;border:2px solid rgba(122,82,52,.25);background:#fff;min-height:50px;display:flex;flex-direction:column;justify-content:space-between;color:var(--muted);cursor:pointer;transition:all 0.2s;position:relative}
    .day-box:hover{border-color:var(--blue);box-shadow:0 2px 8px rgba(37,99,235,0.2);transform:translateY(-2px)}
    .day-box .d{font-weight:700;font-size:14px;line-height:1.1}
    .day-box .badge{align-self:flex-end;font-size:11px;border-radius:8px;padding:2px 6px;border:1px solid rgba(122,82,52,.25);margin-top:4px}
    .badge-regular{background:#e9fbe9;border-color:#a6d8a6}
    .badge-special{background:#ffe5e5;border-color:#ff9b9b}
    .day-box.today{border-color:var(--today);background:linear-gradient(180deg,#fff, #f4eadf);border-width:3px}
    .day-box.today .d{color:var(--todayText);font-size:16px}
    .day-box.completed{background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-color:var(--green)}
    .day-box.partial{background:linear-gradient(135deg,#fefce8,#fef9c3);border-color:var(--yellow)}
    .day-box.has-report::before{content:'üìä';position:absolute;top:2px;right:2px;font-size:12px}
    .month-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .today-hero{display:flex;align-items:center;gap:16px;background:linear-gradient(135deg,#dbeafe,#bfdbfe);border:4px solid var(--blue);border-radius:14px;padding:20px;box-shadow:0 4px 20px rgba(37,99,235,0.4)}
    .today-number{font-size:64px;line-height:1;border-right:4px double var(--blue);padding-right:20px;color:var(--blue);font-weight:700;font-family:'Orbitron',sans-serif}
    .today-meta{display:flex;flex-direction:column}
    .today-meta .big{font-size:26px;font-weight:700;color:var(--blue);font-family:'Orbitron',sans-serif}
    .status{margin-left:auto;font-size:12px;color:#1e40af;font-family:'Orbitron',sans-serif}
    .side-emph{border:4px double var(--green);background:linear-gradient(180deg,#f6fff6,#e9fbe9);padding:14px;border-radius:14px;box-shadow:0 0 10px rgba(59,127,59,0.25)}
    .spec-card{border-left:6px solid var(--bordeaux);padding:16px 18px;margin-bottom:16px;background:linear-gradient(135deg,#fff5f5,#ffe8e8);border-radius:12px;box-shadow:0 4px 12px rgba(139,0,0,0.15)}
    .spec-card strong{color:var(--bordeaux);font-size:18px;display:block;margin-bottom:4px}
    .spec-card small{color:#8b6b5b;display:block;margin-top:4px}
    .spec-card .rooms{margin-top:8px;display:flex;flex-wrap:wrap;gap:6px}
    .spec-card .room-tag{background:#fff;border:2px solid var(--bordeaux);color:var(--bordeaux);padding:4px 10px;border-radius:6px;font-size:13px;font-weight:600}
    .rooms-recap{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:10px;margin-top:12px}
    .room-recap-card{background:#fff;border:3px solid var(--green);border-radius:10px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.08);transition:all 0.2s}
    .room-recap-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(59,127,59,0.3)}
    .room-recap-card .room-number{font-size:20px;font-weight:700;color:var(--green);margin-bottom:4px}
    .room-recap-card .room-count{font-size:14px;color:var(--muted)}
    .room-selector{display:grid;grid-template-columns:repeat(auto-fill,minmax(60px,1fr));gap:6px;margin:10px 0}
    .room-checkbox{display:flex;align-items:center;gap:4px;padding:6px 8px;border:2px solid #d6c8b4;border-radius:6px;background:#fff;cursor:pointer;transition:all 0.2s}
    .room-checkbox:hover{background:#f0f0f0;border-color:var(--green)}
    .room-checkbox input[type=checkbox]{cursor:pointer}
    .room-checkbox.selected{background:var(--green);border-color:var(--green);color:#fff}
    .edit-item{padding:10px;border:2px solid var(--accent);border-radius:8px;margin-bottom:10px;background:#fff}
    .edit-item .actions{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap}
    .deleted-item{padding:10px;border:2px solid #999;border-radius:8px;margin-bottom:10px;background:#f5f5f5}
    .deleted-item .actions{display:flex;gap:6px;margin-top:8px}
    .tabs{display:flex;gap:8px;margin-bottom:12px;border-bottom:2px solid var(--accent)}
    .tab{padding:8px 16px;cursor:pointer;border:none;background:transparent;color:var(--muted);font-weight:600;border-bottom:3px solid transparent;transition:all 0.2s}
    .tab:hover{color:var(--accent)}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent)}
    @media (max-width:980px){ .wrap{grid-template-columns:1fr} header h2{font-size:24px} .rooms-recap{grid-template-columns:repeat(auto-fill,minmax(140px,1fr))} }
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:16px;z-index:50;backdrop-filter:blur(4px)}
    .modal .panel{background:#fff;border:3px double var(--frame);border-radius:12px;max-width:900px;width:100%;padding:20px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,0.3)}
    .modal h3{margin:0 0 12px 0;color:var(--frame);font-size:24px}
    .modal .row{display:flex;gap:8px;margin:6px 0;flex-wrap:wrap}
    .modal input, .modal select{flex:1 1 140px}
    .users-table{width:100%;border-collapse:collapse;margin-top:8px}
    .users-table th,.users-table td{border-bottom:1px dashed #e8dccb;padding:8px;text-align:left}
    
    /* RAPPORT MODAL */
    .report-section{margin:16px 0;padding:12px;border-radius:8px;background:#f9fafb;border:2px solid #e5e7eb}
    .report-section h4{margin:0 0 8px 0;color:var(--blue);font-size:18px;border-bottom:2px solid var(--blue);padding-bottom:4px}
    .timeline-entry{padding:8px 12px;margin:6px 0;background:#fff;border-left:4px solid var(--blue);border-radius:4px;font-size:13px}
    .timeline-entry .time{font-weight:700;color:var(--blue);font-family:'Orbitron',sans-serif}
    .export-buttons{display:flex;gap:10px;margin-top:16px;padding-top:16px;border-top:2px solid #e5e7eb}
    .export-buttons button{flex:1}
    
    @media print{.header-actions,.edit-guard,.no-print,#starwars-intro{display:none!important}}
  </style>
</head>
<body>
  <!-- ANIMATION STAR WARS -->
  <div id="starwars-intro">
    <div class="starwars-text">
      CENTRE DE CONTR√îLE<br>
      TEMPLE DE JEANNE<br>
      <span style="font-size:20px;display:block;margin-top:20px">Syst√®me op√©rationnel</span>
    </div>
  </div>

  <div class="wrap">
    <header>
      <div class="logo"><h1>TDJ</h1></div>
      <div class="header-title">
        <h2>CENTRE DE CONTR√îLE</h2>
        <div class="realtime-info">
          <span id="current-time">--:--:--</span>
          <span id="current-date">-- --- ----</span>
        </div>
      </div>
      <div class="status" id="status-text">‚è≥ Chargement...</div>
      <div class="header-actions no-print">
        <button id="btn-print">Imprimer</button>
        <button id="btn-logout" class="secondary">D√©connexion</button>
        <button id="btn-users">Utilisateurs</button>
      </div>
    </header>
    
    <main class="card main">
      <!-- INFORMATIONS IMPORTANTES -->
      <div class="important-info edit-guard">
        <div class="overlay hidden" id="guard-important">
          <div><p style="margin:0 0 8px 0"><strong>Connexion requise</strong></p><button id="open-login-important">Se connecter</button></div>
        </div>
        <h3>üìù INFORMATIONS IMPORTANTES DU JOUR</h3>
        <textarea id="important-info-text" placeholder="Signaler incidents, informations importantes, notes pour la direction..." rows="3"></textarea>
        <button id="btn-save-important" style="margin-top:8px">üíæ Enregistrer</button>
        <div class="info-history" id="info-history"></div>
      </div>

      <!-- CHECK-LISTES PAR SHIFT -->
      <div class="frame" style="background:linear-gradient(135deg,#eff6ff,#f0f9ff);border:3px solid var(--blue)">
        <h3 style="margin:6px 0 12px 0;color:var(--blue);border-bottom:3px solid var(--blue);padding-bottom:6px;font-size:22px;font-family:'Orbitron',sans-serif">‚úÖ CHECK-LISTES JOURNALI√àRES</h3>
        
        <!-- SHIFT MATIN -->
        <div class="checklist-section">
          <div class="checklist-header">
            <div class="checklist-title">üåÖ SHIFT MATIN (8h-15h)</div>
            <div class="checklist-progress" id="progress-matin">0/16</div>
          </div>
          <div id="checklist-matin"></div>
        </div>

        <!-- SHIFT APR√àS-MIDI -->
        <div class="checklist-section">
          <div class="checklist-header">
            <div class="checklist-title">‚òÄÔ∏è SHIFT APR√àS-MIDI (13h-20h)</div>
            <div class="checklist-progress" id="progress-aprem">0/11</div>
          </div>
          <div id="checklist-aprem"></div>
        </div>

        <!-- SHIFT SOIR/NUIT -->
        <div class="checklist-section">
          <div class="checklist-header">
            <div class="checklist-title">üåô SHIFT SOIR/NUIT (20h-8h)</div>
            <div class="checklist-progress" id="progress-nuit">0/20</div>
          </div>
          <div id="checklist-nuit"></div>
        </div>
      </div>

      <section class="today-hero">
        <div class="today-number" id="today-number">--</div>
        <div class="today-meta">
          <div class="big" id="today-long">Aujourd'hui</div>
          <div class="muted">Consignes du jour & consignes sp√©ciales</div>
        </div>
        <div class="badge-pill" id="count-badge" style="margin-left:auto">0 consignes</div>
      </section>
      
      <div class="frame" style="background:linear-gradient(135deg,#f0fff0,#fafffa);border:3px solid var(--green);box-shadow:0 4px 15px rgba(59,127,59,0.25)">
        <h3 style="margin:6px 0;color:var(--green);border-bottom:3px solid var(--green);padding-bottom:6px;font-size:20px">üìã Consignes du jour</h3>
        <div class="day-list" id="day-list"></div>
      </div>
      
      <div class="frame side-emph">
        <h3 style="margin:6px 0;color:var(--bordeaux);border-bottom:3px solid var(--bordeaux);padding-bottom:6px;font-size:22px">‚≠ê Consignes sp√©ciales actives</h3>
        <div id="active-spec-list"></div>
      </div>

      <div class="frame edit-guard no-print">
        <div class="overlay hidden" id="guard-day">
          <div><p style="margin:0 0 8px 0"><strong>Connexion requise</strong></p><button id="open-login-1">Se connecter</button></div>
        </div>
        <div class="collapsible-header"><h4 style="margin:6px 0">üìù Ajouter une consigne du jour</h4><button class="secondary toggle" id="tgl-add">D√©ployer</button></div>
        <div class="collapsible-body hidden" id="body-add">
          <div class="controls">
            <input id="entry-date" type="date" />
            <input id="entry-title" type="text" placeholder="Titre de la consigne" />
            <button id="btn-add">Ajouter</button>
          </div>
          <div class="controls">
            <input id="filter-date" type="date" />
            <button id="btn-filter" class="secondary">Afficher ce jour</button>
            <button id="btn-today">Aujourd'hui</button>
          </div>
        </div>
      </div>
      
      <div class="frame edit-guard no-print">
        <div class="overlay hidden" id="guard-spec">
          <div><p style="margin:0 0 8px 0"><strong>Connexion requise</strong></p><button id="open-login-3">Se connecter</button></div>
        </div>
        <div class="collapsible-header"><h4 style="margin:6px 0">‚≠ê Consignes sp√©ciales</h4><button class="secondary toggle" id="tgl-spec">D√©ployer</button></div>
        <div class="collapsible-body hidden" id="body-spec">
          <div class="controls">
            <input id="spec-title" type="text" placeholder="Titre de la consigne sp√©ciale" />
            <input id="spec-start" type="date" title="D√©but de validit√©" />
            <input id="spec-end" type="date" title="Fin de validit√©" />
          </div>
          <div class="controls">
            <textarea id="spec-desc" rows="2" placeholder="Description (optionnelle)"></textarea>
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="spec-perma" /> Permanent (sans date de fin)</label>
          </div>
          <div style="margin:10px 0">
            <strong style="display:block;margin-bottom:6px">Chambres concern√©es :</strong>
            <div class="room-selector" id="room-selector"></div>
          </div>
          <button id="btn-add-spec">Ajouter</button>
          <h4 style="margin:12px 0 8px 0;color:var(--green);border-bottom:1px solid var(--green);padding-bottom:2px">Toutes les consignes sp√©ciales</h4>
          <div id="all-spec-list"></div>
        </div>
      </div>
      
      <div class="frame edit-guard no-print">
        <div class="overlay hidden" id="guard-edit">
          <div><p style="margin:0 0 8px 0"><strong>Connexion requise</strong></p><button id="open-login-2">Se connecter</button></div>
        </div>
        <div class="collapsible-header"><h4 style="margin:6px 0">‚úèÔ∏è √âditer / Supprimer consignes</h4><button class="secondary toggle" id="tgl-edit">D√©ployer</button></div>
        <div class="collapsible-body hidden" id="body-edit">
          <h4 style="margin:8px 0;color:var(--green);border-bottom:2px solid var(--green);padding-bottom:4px">Consignes du jour</h4>
          <div id="edit-list"></div>
          <h4 style="margin:16px 0 8px 0;color:var(--bordeaux);border-bottom:2px solid var(--bordeaux);padding-bottom:4px">Consignes sp√©ciales</h4>
          <div id="edit-spec-list"></div>
        </div>
      </div>
      
      <div class="frame edit-guard no-print">
        <div class="overlay hidden" id="guard-history">
          <div><p style="margin:0 0 8px 0"><strong>Connexion requise</strong></p><button id="open-login-4">Se connecter</button></div>
        </div>
        <div class="collapsible-header"><h4 style="margin:6px 0">üóÇÔ∏è Historique des suppressions</h4><button class="secondary toggle" id="tgl-history">D√©ployer</button></div>
        <div class="collapsible-body hidden" id="body-history">
          <div class="tabs">
            <button class="tab active" data-tab="deleted-day">Consignes du jour</button>
            <button class="tab" data-tab="deleted-spec">Consignes sp√©ciales</button>
          </div>
          <div id="deleted-day-list" class="tab-content"></div>
          <div id="deleted-spec-list" class="tab-content hidden"></div>
        </div>
      </div>
    </main>
    
    <aside style="position:sticky;top:24px;align-self:start">
      <div class="frame">
        <div class="month-header">
          <button id="prev-month" class="secondary">‚óÄ</button>
          <div id="month-title" style="font-weight:700"></div>
          <button id="next-month" class="secondary">‚ñ∂</button>
        </div>
        <div class="month-strip" id="month-strip"></div>
        <p class="muted" style="margin-top:8px;font-size:11px">
          <span class="badge badge-regular">Consignes</span> 
          <span class="badge badge-special">Sp√©ciales</span><br>
          üü¢ Complet üü° Partiel üìä Rapport
        </p>
      </div>
      <div class="frame" style="margin-top:12px">
        <h4 style="margin:6px 0 10px 0;color:var(--green);border-bottom:2px solid var(--green);padding-bottom:4px">üè® Chambres avec consignes</h4>
        <div class="rooms-recap" id="rooms-recap"></div>
      </div>
    </aside>
  </div>
  <!-- MODAL UTILISATEURS -->
  <div id="user-modal" class="modal">
    <div class="panel">
      <h3>üë• Utilisateurs</h3>
      <div id="user-status" class="muted" style="margin-bottom:8px"></div>
      <div class="row">
        <input id="login-username" type="text" placeholder="Identifiant" />
        <input id="login-password" type="password" placeholder="Mot de passe" />
        <button id="btn-login">Connexion</button>
      </div>
      <div class="row">
        <input id="new-username" type="text" placeholder="Nouvel identifiant" />
        <input id="new-password" type="password" placeholder="Nouveau mot de passe" />
        <select id="new-role"><option value="user">Utilisateur</option><option value="admin">Admin</option></select>
        <button id="btn-create-user" class="secondary">Cr√©er</button>
      </div>
      <h4 style="margin-top:12px">Liste des utilisateurs</h4>
      <table class="users-table"><thead><tr><th>Identifiant</th><th>R√¥le</th><th>Actions</th></tr></thead><tbody id="users-list"></tbody></table>
      <div style="margin-top:10px"><button id="btn-close-users" class="secondary">Fermer</button></div>
    </div>
  </div>

  <!-- MODAL √âDITION -->
  <div id="edit-modal" class="modal">
    <div class="panel">
      <h3 id="edit-modal-title">√âditer la consigne</h3>
      <input type="hidden" id="edit-item-id" />
      <input type="hidden" id="edit-item-type" />
      <div style="margin:12px 0">
        <label style="display:block;margin-bottom:4px;font-weight:600">Titre :</label>
        <input id="edit-item-title" type="text" style="width:100%" />
      </div>
      <div id="edit-spec-fields" class="hidden">
        <div style="margin:12px 0">
          <label style="display:block;margin-bottom:4px;font-weight:600">Description :</label>
          <textarea id="edit-item-desc" rows="3" style="width:100%"></textarea>
        </div>
        <div class="row">
          <div style="flex:1">
            <label style="display:block;margin-bottom:4px;font-weight:600">D√©but :</label>
            <input id="edit-item-start" type="date" />
          </div>
          <div style="flex:1">
            <label style="display:block;margin-bottom:4px;font-weight:600">Fin :</label>
            <input id="edit-item-end" type="date" />
          </div>
        </div>
        <div style="margin:12px 0">
          <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="edit-item-perma" /> Permanent (sans date de fin)</label>
        </div>
        <div style="margin:12px 0">
          <strong style="display:block;margin-bottom:6px">Chambres concern√©es :</strong>
          <div class="room-selector" id="edit-room-selector"></div>
        </div>
      </div>
      <div style="display:flex;gap:8px;margin-top:16px">
        <button id="btn-save-edit">üíæ Enregistrer</button>
        <button id="btn-cancel-edit" class="secondary">Annuler</button>
      </div>
    </div>
  </div>

  <!-- MODAL RAPPORT JOURNALIER -->
  <div id="report-modal" class="modal">
    <div class="panel">
      <h3 id="report-title">üìä Rapport H√¥tel du --/--/----</h3>
      <div id="report-content"></div>
      <div class="export-buttons">
        <button id="btn-export-pdf">üì• Exporter PDF</button>
        <button id="btn-export-excel" class="secondary">üìÑ Exporter Excel</button>
        <button id="btn-print-report" class="secondary">üñ®Ô∏è Imprimer</button>
        <button id="btn-close-report" class="secondary">‚úñÔ∏è Fermer</button>
      </div>
    </div>
  </div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const SUPABASE_URL='https://nuzvzkyngltjvcmdbzcp.supabase.co';
const SUPABASE_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51enZ6a3luZ2x0anZjbWRiemNwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjUxNzk2ODEsImV4cCI6MjA4MDc1NTY4MX0.TiB7ZDcxeNls9I0MwcSagaMpbMRC4DrDQ5T1SJkgzCY';
const supabase=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);
const ROOMS=['11','12','21','22','23','24','31','32','33','34','41','42','43','44','51','52','61'];

// CHECK-LISTES TEMPLATE
const CHECKLISTS={
  matin:[
    'Lire Rapport / Consignes',
    'Se connecter √† sa session Medialog',
    'V√©rifier la caisse',
    'Lancer la musique uniquement r√©ception/cave',
    'Faire fiche des √©tages par personnel de chambre',
    '8h-10h: Aider au PDJ quand c\'est possible/n√©cessaire',
    '9h: Lancer la musique dans les √©tages (volume sonores bas)',
    'Passer l\'aspirateur √† la fin du PDJ',
    'Faire toutes les v√©rifications r√©servations',
    'Faire au minimum 7 v√©rif2 sur le planning',
    'Apr√®s le dernier check-out: compter sa caisse et faire sa fiche caisse',
    'Cl√¥turer shift et effectuer la main courante apr√®s dernier check-out',
    'D√©sactiver chauffage des chambres vides et sans arriv√©es',
    'Ranger les fiches PDJ et √©tage dans le module de tri',
    'Monter les bagages des arriv√©es stock√©s en bagagerie',
    'Pr√©parer les pochettes de carte des arriv√©es'
  ],
  aprem:[
    'Lire Rapport / Consignes',
    'Se connecter √† sa session Medialog',
    'V√©rifier la caisse',
    'Programmer les cartes chambre',
    '(Lundi uniquement) Faire la commande Marly',
    'Faire toutes les v√©rifications r√©servations',
    'Faire au minimum 7 v√©rif2 sur le planning',
    'Compter les PDJ pour le lendemain',
    'Remplir fiche horaires PDJ du lendemain',
    'Passer la commande boulangerie',
    '√Ä la fin du shift, compter sa caisse et faire la fiche caisse'
  ],
  nuit:[
    'Lire Rapport / Consignes',
    'Se connecter √† sa session Medialog',
    'V√©rifier la caisse',
    '22h15~ : Fermer la grille et √©teindre la musique en √©tage',
    '√âteindre les 2 lustres',
    'Laver et S√©cher linge vers 00h',
    'Faire rondes dans les √©tages',
    'Remplir infos clients d√©parts/arriv√©es du lendemain dans ce rapport h√¥tel',
    'Faire la fiche des chambres (d√©parts+recouches)',
    'Faire toutes les v√©rifications r√©servations',
    'Faire au minimum 7 v√©rif2 sur le planning',
    'Vider poubelle R√©ception + Cuisine',
    'Sortir la bene vers 5h',
    'Ouvrir la grille vers 6h',
    '6h30-45: Rentrer la bene',
    'Passer aspirateur/balai r√©ception et couloir entr√©e',
    'R√©ceptionner + Compter la commande boulangerie',
    '7h15~ : Mettre en place les tables PDJ et tours viennoiseries',
    'Rallumer les lustres',
    'Compter sa caisse et faire sa fiche caisse'
  ]
};

window.addEventListener('DOMContentLoaded',async function(){
// Animation Star Wars
setTimeout(()=>{
  const intro=document.getElementById('starwars-intro');
  if(intro)intro.classList.add('hidden');
},4000);

// Horloge temps r√©el
function updateClock(){
  const now=new Date();
  document.getElementById('current-time').textContent=now.toLocaleTimeString('fr-FR');
  document.getElementById('current-date').textContent=now.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
}
updateClock();
setInterval(updateClock,1000);

let serverStatus='ok';
const storage={
async get(k){try{const{data,error}=await supabase.from('tdj_data').select('value').eq('key',k).single();if(error&&error.code!=='PGRST116'){console.error('Error:',error);serverStatus='error';updateServerStatus();return null}serverStatus='ok';updateServerStatus();return data?data.value:null}catch(e){console.error(e);serverStatus='error';updateServerStatus();return null}},
async set(k,v){try{const{error}=await supabase.from('tdj_data').upsert({key:k,value:v},{onConflict:'key'});if(error){console.error('Error:',error);serverStatus='error';updateServerStatus();alert('‚ö†Ô∏è Erreur: '+error.message);return}serverStatus='ok';updateServerStatus()}catch(e){console.error(e);serverStatus='error';updateServerStatus();alert('‚ö†Ô∏è Erreur: '+e.message)}}
};

function pad(n){return String(n).padStart(2,'0')}
function localDateStr(d){return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())}
function parseYmd(s){const[y,m,dd]=s.split('-').map(Number);return new Date(y,(m||1)-1,dd||1)}
function isDateInRange(d,s,e){return(!s||d>=s)&&(!e||d<=e)}

async function ensureDefaults(){
  if(!await storage.get('tdj_entries'))await storage.set('tdj_entries',{});
  if(!await storage.get('tdj_specs'))await storage.set('tdj_specs',[]);
  if(!await storage.get('tdj_deleted'))await storage.set('tdj_deleted',{day:[],spec:[]});
  if(!await storage.get('tdj_checklists'))await storage.set('tdj_checklists',{});
  if(!await storage.get('tdj_daily_reports'))await storage.set('tdj_daily_reports',{});
  if(!await storage.get('tdj_users'))await storage.set('tdj_users',[{username:'admin',password:'temple123',name:'Admin',role:'admin'}]);
  if(!await storage.get('tdj_current_user'))await storage.set('tdj_current_user',null);
}
ensureDefaults();

const monthStrip=document.getElementById('month-strip'),monthTitle=document.getElementById('month-title'),todayNum=document.getElementById('today-number'),todayLong=document.getElementById('today-long'),dayList=document.getElementById('day-list'),countBadge=document.getElementById('count-badge'),statusEl=document.getElementById('status-text'),guardDay=document.getElementById('guard-day'),guardEdit=document.getElementById('guard-edit'),guardSpec=document.getElementById('guard-spec'),guardHistory=document.getElementById('guard-history'),guardImportant=document.getElementById('guard-important'),modal=document.getElementById('user-modal'),editModal=document.getElementById('edit-modal'),reportModal=document.getElementById('report-modal'),userStatus=document.getElementById('user-status'),usersListTbody=document.getElementById('users-list'),editList=document.getElementById('edit-list'),editSpecList=document.getElementById('edit-spec-list'),activeSpecList=document.getElementById('active-spec-list'),allSpecList=document.getElementById('all-spec-list'),roomsRecap=document.getElementById('rooms-recap'),roomSelector=document.getElementById('room-selector'),editRoomSelector=document.getElementById('edit-room-selector'),deletedDayList=document.getElementById('deleted-day-list'),deletedSpecList=document.getElementById('deleted-spec-list'),importantInfoText=document.getElementById('important-info-text'),infoHistory=document.getElementById('info-history');

let currentMonthDate=new Date(),selectedDate=localDateStr(new Date());
  function buildRoomSelector(containerId){const container=document.getElementById(containerId);if(!container)return;container.innerHTML=ROOMS.map(r=>'<label class="room-checkbox" data-room="'+r+'"><input type="checkbox" value="'+r+'"> Ch. '+r+'</label>').join('');container.querySelectorAll('.room-checkbox').forEach(lbl=>{lbl.addEventListener('click',function(e){if(e.target.tagName!=='INPUT'){const chk=lbl.querySelector('input[type=checkbox]');chk.checked=!chk.checked}lbl.classList.toggle('selected',lbl.querySelector('input[type=checkbox]').checked)})})}
buildRoomSelector('room-selector');buildRoomSelector('edit-room-selector');

async function getCurrentUser(){return await storage.get('tdj_current_user')}
async function setCurrentUser(u){await storage.set('tdj_current_user',u);await renderAuthStatus()}
async function getUsers(){const raw=await storage.get('tdj_users');let arr=Array.isArray(raw)?raw:[];arr=arr.filter(Boolean).map(u=>({username:String(u.username||'').trim(),password:String(u.password||''),role:u.role==='admin'?'admin':'user',name:u.name||u.username})).filter(u=>u.username);if(!arr.some(u=>u.role==='admin'))arr.push({username:'admin',password:'temple123',name:'Admin',role:'admin'});return arr}

function updateServerStatus(){getCurrentUser().then(cu=>{let txt='Statut : '+(cu?('üü¢ '+cu.name+(cu.role?' - '+cu.role:'')):' üî¥ Non connect√©');txt+=' ¬∑ Serveur : '+(serverStatus==='ok'?'‚úÖ OK':'‚ùå Erreur');if(statusEl)statusEl.textContent=txt}).catch(()=>{if(statusEl)statusEl.textContent='Statut : Non connect√© ¬∑ Serveur : '+(serverStatus==='ok'?'‚úÖ OK':'‚ùå Erreur')})}

function updateTodayHero(d){const dt=parseYmd(d);todayNum.textContent=String(dt.getDate());todayLong.textContent=dt.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'})}

async function renderAuthStatus(){const cu=await getCurrentUser();updateServerStatus();userStatus.textContent=cu?('üü¢ Connect√© : '+(cu.name||cu.username)+(cu.role?' ('+cu.role+')':'')):'üî¥ Non connect√©';const enabled=!!cu;[document.getElementById('entry-date'),document.getElementById('entry-title'),document.getElementById('btn-add'),document.getElementById('spec-title'),document.getElementById('spec-desc'),document.getElementById('spec-start'),document.getElementById('spec-end'),document.getElementById('spec-perma'),document.getElementById('btn-add-spec'),document.getElementById('important-info-text'),document.getElementById('btn-save-important')].forEach(el=>{if(el)el.disabled=!enabled});[guardDay,guardEdit,guardSpec,guardHistory,guardImportant].forEach(g=>{if(g)g.classList.toggle('hidden',enabled)});await renderUsersTable()}

async function renderUsersTable(){if(!usersListTbody)return;const me=await getCurrentUser();const canAdmin=!!(me&&me.role==='admin');const users=await getUsers();usersListTbody.innerHTML=users.map(u=>'<tr><td>'+u.username+'</td><td>'+u.role+'</td><td>'+(canAdmin&&u.username!=='admin'?'<button class="secondary btn-del-user" data-u="'+u.username+'">Supprimer</button>':'')+'</td></tr>').join('');usersListTbody.querySelectorAll('.btn-del-user').forEach(b=>{b.addEventListener('click',async function(){if(!canAdmin||!confirm('Supprimer "'+b.dataset.u+'" ?'))return;let arr=await getUsers();arr=arr.filter(x=>x.username!==b.dataset.u);if(!arr.some(x=>x.role==='admin'))arr.push({username:'admin',password:'temple123',name:'Admin',role:'admin'});await storage.set('tdj_users',arr);const cu=await getCurrentUser();if(cu&&cu.username===b.dataset.u)await setCurrentUser(null);await renderUsersTable()})})}

async function addToDeleted(item,type){const deleted=await storage.get('tdj_deleted')||{day:[],spec:[]};const archive={...item,deletedAt:Date.now(),deletedBy:(await getCurrentUser())?.name||'Inconnu'};if(type==='day')deleted.day.unshift(archive);else deleted.spec.unshift(archive);await storage.set('tdj_deleted',deleted)}

async function renderChecklists(date){const checklists=await storage.get('tdj_checklists')||{};const todayData=checklists[date]||{matin:[],aprem:[],nuit:[]};['matin','aprem','nuit'].forEach(shift=>{const container=document.getElementById('checklist-'+shift);const progress=document.getElementById('progress-'+shift);if(!container||!progress)return;const items=CHECKLISTS[shift];const checked=todayData[shift]||[];const html=items.map((item,i)=>{const isChecked=checked.includes(i);return '<div class="checklist-item'+(isChecked?' checked':'')+'" data-shift="'+shift+'" data-index="'+i+'"><input type="checkbox" '+(isChecked?'checked':'')+' class="checklist-check"><label>'+item+'</label></div>'}).join('');container.innerHTML=html;progress.textContent=checked.length+'/'+items.length;container.querySelectorAll('.checklist-check').forEach(chk=>{chk.addEventListener('change',async function(){const item=chk.closest('.checklist-item');const shift=item.dataset.shift;const index=Number(item.dataset.index);const checklists=await storage.get('tdj_checklists')||{};if(!checklists[date])checklists[date]={matin:[],aprem:[],nuit:[]};if(!checklists[date][shift])checklists[date][shift]=[];if(chk.checked){if(!checklists[date][shift].includes(index))checklists[date][shift].push(index);item.classList.add('checked')}else{checklists[date][shift]=checklists[date][shift].filter(x=>x!==index);item.classList.remove('checked')}await storage.set('tdj_checklists',checklists);const cu=await getCurrentUser();await addToTimeline(date,cu?.name||'Utilisateur',shift,CHECKLISTS[shift][index],chk.checked);renderChecklists(date);buildMonthStrip(currentMonthDate)})})});await archiveDailyIfNeeded()}

async function addToTimeline(date,user,shift,action,checked){const reports=await storage.get('tdj_daily_reports')||{};if(!reports[date])reports[date]={timeline:[],importantInfo:''};reports[date].timeline.push({time:new Date().toLocaleTimeString('fr-FR'),user,shift,action,checked});await storage.set('tdj_daily_reports',reports)}

async function archiveDailyIfNeeded(){const now=new Date();const today=localDateStr(now);if(now.getHours()===0&&now.getMinutes()===0){console.log('üîÑ Archivage automatique...');await renderChecklists(today)}}

async function loadImportantInfo(date){const reports=await storage.get('tdj_daily_reports')||{};const info=reports[date]?.importantInfo||'';if(importantInfoText)importantInfoText.value=info;await renderInfoHistory()}

async function renderInfoHistory(){if(!infoHistory)return;const reports=await storage.get('tdj_daily_reports')||{};const dates=Object.keys(reports).filter(d=>reports[d].importantInfo).sort().reverse().slice(0,5);if(dates.length===0){infoHistory.innerHTML='<p class="muted" style="margin:0">Aucune information archiv√©e</p>';return}infoHistory.innerHTML=dates.map(d=>'<div class="info-entry"><strong>'+parseYmd(d).toLocaleDateString('fr-FR')+'</strong><p style="margin:4px 0">'+reports[d].importantInfo+'</p></div>').join('')}

document.getElementById('btn-save-important').addEventListener('click',async function(){const cu=await getCurrentUser();if(!cu){alert('Connectez-vous');return}const text=importantInfoText.value.trim();const reports=await storage.get('tdj_daily_reports')||{};if(!reports[selectedDate])reports[selectedDate]={timeline:[],importantInfo:''};reports[selectedDate].importantInfo=text;await storage.set('tdj_daily_reports',reports);alert('‚úÖ Informations enregistr√©es');renderInfoHistory()});

async function renderDay(d){const dt=d||localDateStr(new Date());selectedDate=dt;document.getElementById('filter-date').value=dt;document.getElementById('entry-date').value=dt;updateTodayHero(dt);const entries=await storage.get('tdj_entries')||{};const list=entries[dt]||[];list.forEach(it=>{if(!it.id)it.id='e_'+it.t+'_'+Math.random().toString(36).slice(2,6);if(typeof it.done!=='boolean')it.done=false;if(!it.createdDate)it.createdDate=dt;if(typeof it.reportCount!=='number')it.reportCount=0});dayList.innerHTML=list.length?list.map(e=>'<div class="entry'+(e.done?' done':'')+'" data-id="'+e.id+'"><div class="row"><input type="checkbox" class="entry-check" data-id="'+e.id+'"'+(e.done?' checked':'')+'> <strong>'+e.title+'</strong></div><small>‚Äî '+(e.by||'')+' '+new Date(e.t).toLocaleTimeString()+'</small>'+(e.reportCount>0?'<div class="meta">üìÖ Report√©e '+e.reportCount+' fois ‚Ä¢ Cr√©√©e le '+e.createdDate+'</div>':'')+'</div>').join(''):'<p class="muted">Aucune consigne</p>';countBadge.textContent=list.length+' consigne'+(list.length>1?'s':'');document.querySelectorAll('.entry-check').forEach(chk=>{chk.addEventListener('change',async function(ev){const id=ev.target.dataset.id;const entries=await storage.get('tdj_entries')||{};const list=entries[dt]||[];const item=list.find(x=>x.id===id);if(!item)return;item.done=!!ev.target.checked;await storage.set('tdj_entries',entries);renderDay(dt);buildMonthStrip(currentMonthDate)})});await renderEditList(dt);await renderSpecs(dt);await renderRoomsRecap(dt);await renderChecklists(dt);await loadImportantInfo(dt)}

async function renderEditList(d){if(!editList)return;const entries=await storage.get('tdj_entries')||{};const list=entries[d]||[];editList.innerHTML=list.length?list.map((e,i)=>'<div class="edit-item"><strong>'+e.title+'</strong><br><small>'+(e.by||'')+' - '+new Date(e.t).toLocaleTimeString()+'</small>'+(e.reportCount>0?'<br><small class="meta">üìÖ Report√©e '+e.reportCount+' fois ‚Ä¢ Cr√©√©e le '+e.createdDate+'</small>':'')+'<div class="actions"><button class="secondary small btn-edit-entry" data-i="'+i+'">‚úèÔ∏è √âditer</button><button class="secondary small btn-report-entry" data-i="'+i+'">üìÖ Reporter</button><button class="secondary small btn-del-edit" data-i="'+i+'">üóëÔ∏è Supprimer</button></div></div>').join(''):'<p class="muted">Aucune consigne du jour</p>';editList.querySelectorAll('.btn-edit-entry').forEach(b=>{b.addEventListener('click',function(){openEditModal(d,'day',Number(b.dataset.i))})});editList.querySelectorAll('.btn-report-entry').forEach(b=>{b.addEventListener('click',async function(){if(!confirm('Reporter cette consigne au lendemain ?'))return;const i=Number(b.dataset.i);const entries=await storage.get('tdj_entries')||{};const item=entries[d][i];const nextDate=localDateStr(new Date(parseYmd(d).getTime()+86400000));if(!entries[nextDate])entries[nextDate]=[];const reported={...item,id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),t:Date.now(),reportCount:(item.reportCount||0)+1,createdDate:item.createdDate||d};entries[nextDate].unshift(reported);await storage.set('tdj_entries',entries);alert('‚úÖ Consigne report√©e au '+nextDate);renderDay(d);buildMonthStrip(currentMonthDate)})});editList.querySelectorAll('.btn-del-edit').forEach(b=>{b.addEventListener('click',async function(){if(!confirm('Supprimer cette consigne ?'))return;const i=Number(b.dataset.i);const entries=await storage.get('tdj_entries')||{};const item=entries[d][i];await addToDeleted({...item,originalDate:d},'day');entries[d].splice(i,1);await storage.set('tdj_entries',entries);renderDay(d);buildMonthStrip(currentMonthDate);renderDeletedHistory()})})}

async function renderEditSpecList(){if(!editSpecList)return;const specs=await storage.get('tdj_specs')||[];editSpecList.innerHTML=specs.length?specs.map((s,i)=>'<div class="edit-item"><strong style="color:var(--bordeaux)">'+s.title+'</strong><br><small>Valide: '+s.start+' ‚Üí '+((s.end&&s.end.length)?s.end:'‚àû')+'</small>'+(s.desc?'<p style="margin:4px 0 0 0;font-size:13px">'+s.desc+'</p>':'')+(s.rooms&&s.rooms.length?'<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">'+s.rooms.map(r=>'<span style="background:var(--bordeaux);color:#fff;padding:3px 8px;border-radius:4px;font-size:12px">Ch. '+r+'</span>').join('')+'</div>':'')+'<div class="actions"><button class="secondary small btn-edit-spec" data-i="'+i+'">‚úèÔ∏è √âditer</button><button class="secondary small btn-del-spec" data-i="'+i+'">üóëÔ∏è Supprimer</button></div></div>').join(''):'<p class="muted">Aucune consigne sp√©ciale</p>';editSpecList.querySelectorAll('.btn-edit-spec').forEach(b=>{b.addEventListener('click',function(){openEditModal(null,'spec',Number(b.dataset.i))})});editSpecList.querySelectorAll('.btn-del-spec').forEach(b=>{b.addEventListener('click',async function(){if(!confirm('Supprimer cette consigne sp√©ciale ?'))return;const i=Number(b.dataset.i);const specs=await storage.get('tdj_specs')||[];const item=specs[i];await addToDeleted(item,'spec');specs.splice(i,1);await storage.set('tdj_specs',specs);renderEditSpecList();renderSpecs(selectedDate);buildMonthStrip(currentMonthDate);renderRoomsRecap(selectedDate);renderDeletedHistory()})})}
  async function renderSpecs(d){const specs=await storage.get('tdj_specs')||[];const active=specs.filter(s=>isDateInRange(d,s.start,s.end||(s.perma?'9999-12-31':'')));if(activeSpecList)activeSpecList.innerHTML=active.length?active.map(s=>'<div class="spec-card"><strong>'+s.title+'</strong><small>Valide: '+s.start+' ‚Üí '+((s.end&&s.end.length)?s.end:'‚àû')+'</small>'+(s.desc?'<p style="margin:6px 0 0 0">'+s.desc+'</p>':'')+(s.rooms&&s.rooms.length?'<div class="rooms">'+s.rooms.map(r=>'<span class="room-tag">Ch. '+r+'</span>').join('')+'</div>':'<div class="rooms"><span class="room-tag" style="background:#f0f0f0;border-color:#999;color:#666">Toutes les chambres</span></div>')+'</div>').join(''):'<p class="muted">Aucune consigne sp√©ciale active</p>';if(allSpecList)allSpecList.innerHTML=specs.length?specs.map(s=>'<div style="padding:12px;border:2px solid var(--bordeaux);border-radius:8px;margin-bottom:10px;background:#fff"><strong style="color:var(--bordeaux)">'+s.title+'</strong><br><small>Valide: '+s.start+' ‚Üí '+((s.end&&s.end.length)?s.end:'‚àû')+'</small>'+(s.desc?'<p style="margin:4px 0 0 0">'+s.desc+'</p>':'')+(s.rooms&&s.rooms.length?'<div style="margin-top:6px;display:flex;flex-wrap:wrap;gap:4px">'+s.rooms.map(r=>'<span style="background:var(--bordeaux);color:#fff;padding:3px 8px;border-radius:4px;font-size:12px">Ch. '+r+'</span>').join('')+'</div>':'<div style="margin-top:6px"><span style="background:#e0e0e0;padding:3px 8px;border-radius:4px;font-size:12px">Toutes les chambres</span></div>')+'</div>').join(''):'<p class="muted">Aucune consigne sp√©ciale</p>'}

async function renderRoomsRecap(d){if(!roomsRecap)return;const specs=await storage.get('tdj_specs')||[];const active=specs.filter(s=>isDateInRange(d,s.start,s.end||(s.perma?'9999-12-31':'')));const roomCounts={};ROOMS.forEach(r=>roomCounts[r]=0);active.forEach(s=>{if(!s.rooms||!s.rooms.length){ROOMS.forEach(r=>roomCounts[r]++)}else{s.rooms.forEach(r=>{if(roomCounts[r]!==undefined)roomCounts[r]++})}});const withConsignes=Object.entries(roomCounts).filter(([r,c])=>c>0).sort((a,b)=>b[1]-a[1]);if(withConsignes.length===0){roomsRecap.innerHTML='<p class="muted" style="grid-column:1/-1">Aucune chambre avec consignes sp√©ciales actives</p>';return}roomsRecap.innerHTML=withConsignes.map(([r,c])=>'<div class="room-recap-card"><div class="room-number">Ch. '+r+'</div><div class="room-count">'+c+' consigne'+(c>1?'s':'')+'</div></div>').join('')}

async function renderDeletedHistory(){const deleted=await storage.get('tdj_deleted')||{day:[],spec:[]};if(deletedDayList)deletedDayList.innerHTML=deleted.day.length?deleted.day.map((e,i)=>'<div class="deleted-item"><strong>'+e.title+'</strong><br><small>Supprim√©e le '+new Date(e.deletedAt).toLocaleString()+' par '+e.deletedBy+'</small>'+(e.originalDate?'<br><small>Date originale: '+e.originalDate+'</small>':'')+'<div class="actions"><button class="secondary small btn-restore-day" data-i="'+i+'">‚Ü©Ô∏è Restaurer</button></div></div>').join(''):'<p class="muted">Aucune consigne supprim√©e</p>';if(deletedSpecList)deletedSpecList.innerHTML=deleted.spec.length?deleted.spec.map((s,i)=>'<div class="deleted-item"><strong style="color:var(--bordeaux)">'+s.title+'</strong><br><small>Supprim√©e le '+new Date(s.deletedAt).toLocaleString()+' par '+s.deletedBy+'</small><br><small>Validit√©: '+s.start+' ‚Üí '+((s.end&&s.end.length)?s.end:'‚àû')+'</small><div class="actions"><button class="secondary small btn-restore-spec" data-i="'+i+'">‚Ü©Ô∏è Restaurer</button></div></div>').join(''):'<p class="muted">Aucune consigne sp√©ciale supprim√©e</p>';deletedDayList.querySelectorAll('.btn-restore-day').forEach(b=>{b.addEventListener('click',async function(){if(!confirm('Restaurer cette consigne ?'))return;const i=Number(b.dataset.i);const deleted=await storage.get('tdj_deleted')||{day:[],spec:[]};const item=deleted.day[i];const restoreDate=item.originalDate||localDateStr(new Date());const entries=await storage.get('tdj_entries')||{};if(!entries[restoreDate])entries[restoreDate]=[];const{deletedAt,deletedBy,originalDate,...cleanItem}=item;entries[restoreDate].unshift({...cleanItem,id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),t:Date.now()});await storage.set('tdj_entries',entries);deleted.day.splice(i,1);await storage.set('tdj_deleted',deleted);alert('‚úÖ Consigne restaur√©e au '+restoreDate);renderDay(selectedDate);buildMonthStrip(currentMonthDate);renderDeletedHistory()})});deletedSpecList.querySelectorAll('.btn-restore-spec').forEach(b=>{b.addEventListener('click',async function(){if(!confirm('Restaurer cette consigne sp√©ciale ?'))return;const i=Number(b.dataset.i);const deleted=await storage.get('tdj_deleted')||{day:[],spec:[]};const item=deleted.spec[i];const specs=await storage.get('tdj_specs')||[];const{deletedAt,deletedBy,...cleanItem}=item;specs.push({...cleanItem,id:'s_'+Date.now()});await storage.set('tdj_specs',specs);deleted.spec.splice(i,1);await storage.set('tdj_deleted',deleted);alert('‚úÖ Consigne sp√©ciale restaur√©e');renderEditSpecList();renderSpecs(selectedDate);buildMonthStrip(currentMonthDate);renderRoomsRecap(selectedDate);renderDeletedHistory()}})}

function openEditModal(date,type,index){document.getElementById('edit-item-id').value=index;document.getElementById('edit-item-type').value=type;const specFields=document.getElementById('edit-spec-fields');if(type==='day'){storage.get('tdj_entries').then(e=>{const item=(e||{})[date][index];document.getElementById('edit-modal-title').textContent='‚úèÔ∏è √âditer la consigne du jour';document.getElementById('edit-item-title').value=item.title;specFields.classList.add('hidden');editModal.style.display='flex'})}else{storage.get('tdj_specs').then(specs=>{const item=specs[index];document.getElementById('edit-modal-title').textContent='‚úèÔ∏è √âditer la consigne sp√©ciale';document.getElementById('edit-item-title').value=item.title;document.getElementById('edit-item-desc').value=item.desc||'';document.getElementById('edit-item-start').value=item.start;document.getElementById('edit-item-end').value=item.end||'';document.getElementById('edit-item-perma').checked=!!item.perma;specFields.classList.remove('hidden');document.querySelectorAll('#edit-room-selector input[type=checkbox]').forEach(c=>{c.checked=(item.rooms||[]).includes(c.value);c.closest('.room-checkbox').classList.toggle('selected',c.checked)});editModal.style.display='flex'})}}

document.getElementById('btn-save-edit').addEventListener('click',async function(){const type=document.getElementById('edit-item-type').value;const index=Number(document.getElementById('edit-item-id').value);const newTitle=document.getElementById('edit-item-title').value.trim();if(!newTitle){alert('Titre requis');return}if(type==='day'){const entries=await storage.get('tdj_entries')||{};const item=entries[selectedDate][index];item.title=newTitle;await storage.set('tdj_entries',entries);renderDay(selectedDate)}else{const specs=await storage.get('tdj_specs')||[];const item=specs[index];item.title=newTitle;item.desc=document.getElementById('edit-item-desc').value.trim();item.start=document.getElementById('edit-item-start').value;const perma=document.getElementById('edit-item-perma').checked;item.end=perma?'':document.getElementById('edit-item-end').value;item.perma=perma;item.rooms=Array.from(document.querySelectorAll('#edit-room-selector input[type=checkbox]:checked')).map(c=>c.value);await storage.set('tdj_specs',specs);renderEditSpecList();renderSpecs(selectedDate);buildMonthStrip(currentMonthDate);renderRoomsRecap(selectedDate)}editModal.style.display='none'});

document.getElementById('btn-cancel-edit').addEventListener('click',function(){editModal.style.display='none'});
editModal.addEventListener('click',function(e){if(e.target===editModal)editModal.style.display='none'});

async function openReportModal(date){const dt=parseYmd(date);document.getElementById('report-title').textContent='üìä Rapport H√¥tel du '+dt.toLocaleDateString('fr-FR',{weekday:'long',day:'numeric',month:'long',year:'numeric'});const reports=await storage.get('tdj_daily_reports')||{};const checklists=await storage.get('tdj_checklists')||{};const entries=await storage.get('tdj_entries')||{};const specs=await storage.get('tdj_specs')||[];const dayData=reports[date]||{timeline:[],importantInfo:''};const checkData=checklists[date]||{matin:[],aprem:[],nuit:[]};const dayEntries=entries[date]||[];const activeSpecs=specs.filter(s=>isDateInRange(date,s.start,s.end||(s.perma?'9999-12-31':'')));let html='';if(dayData.importantInfo){html+='<div class="report-section"><h4>üìù Informations Importantes</h4><p>'+dayData.importantInfo+'</p></div>'}html+='<div class="report-section"><h4>‚úÖ Check-listes - Taux de compl√©tion</h4>';html+='<p>üåÖ <strong>Matin:</strong> '+checkData.matin.length+'/'+CHECKLISTS.matin.length+' ('+(checkData.matin.length===CHECKLISTS.matin.length?'100':''+Math.round(checkData.matin.length/CHECKLISTS.matin.length*100))+'%)</p>';html+='<p>‚òÄÔ∏è <strong>Apr√®s-midi:</strong> '+checkData.aprem.length+'/'+CHECKLISTS.aprem.length+' ('+(checkData.aprem.length===CHECKLISTS.aprem.length?'100':''+Math.round(checkData.aprem.length/CHECKLISTS.aprem.length*100))+'%)</p>';html+='<p>üåô <strong>Soir/Nuit:</strong> '+checkData.nuit.length+'/'+CHECKLISTS.nuit.length+' ('+(checkData.nuit.length===CHECKLISTS.nuit.length?'100':''+Math.round(checkData.nuit.length/CHECKLISTS.nuit.length*100))+'%)</p></div>';if(dayData.timeline&&dayData.timeline.length>0){html+='<div class="report-section"><h4>‚è∞ Timeline du jour</h4>';dayData.timeline.forEach(e=>{html+='<div class="timeline-entry"><span class="time">'+e.time+'</span> - '+e.user+' ('+e.shift+'): '+e.action+' '+(e.checked?'‚úì':'‚úó')+'</div>'});html+='</div>'}if(dayEntries.length>0){html+='<div class="report-section"><h4>üìã Consignes du jour</h4>';dayEntries.forEach(e=>{html+='<p>‚Ä¢ '+e.title+' - '+(e.done?'‚úÖ Compl√©t√©':'‚è≥ En cours')+'</p>'});html+='</div>'}if(activeSpecs.length>0){html+='<div class="report-section"><h4>‚≠ê Consignes sp√©ciales actives</h4>';activeSpecs.forEach(s=>{html+='<p><strong>'+s.title+'</strong><br>'+s.start+' ‚Üí '+(s.end||'‚àû')+(s.desc?' - '+s.desc:'')+(s.rooms&&s.rooms.length?' - Chambres: '+s.rooms.join(', '):'')+'</p>'});html+='</div>'}document.getElementById('report-content').innerHTML=html;reportModal.style.display='flex'}

document.getElementById('btn-export-pdf').addEventListener('click',function(){alert('üì• Export PDF en cours de d√©veloppement...')});
document.getElementById('btn-export-excel').addEventListener('click',function(){alert('üìÑ Export Excel en cours de d√©veloppement...')});
document.getElementById('btn-print-report').addEventListener('click',function(){window.print()});
document.getElementById('btn-close-report').addEventListener('click',function(){reportModal.style.display='none'});
reportModal.addEventListener('click',function(e){if(e.target===reportModal)reportModal.style.display='none'});

const WEEKDAYS=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
async function buildMonthStrip(base){const y=base.getFullYear(),m=base.getMonth();const first=new Date(y,m,1),last=new Date(y,m+1,0);const sw=(first.getDay()+6)%7;monthTitle.textContent=first.toLocaleDateString('fr-FR',{month:'long',year:'numeric'});const todayStr=localDateStr(new Date());let html='';html+=WEEKDAYS.map(w=>'<div class="weekday">'+w+'</div>').join('');const tot=Math.ceil((sw+last.getDate())/7)*7;for(let i=0;i<tot;i++){if(i<sw||(i-sw+1)>last.getDate()){html+='<div></div>';continue}const dn=i-sw+1;const ds=y+'-'+pad(m+1)+'-'+pad(dn);const isT=(ds===todayStr);html+='<button class="day-box'+(isT?' today':'')+'" data-date="'+ds+'"><span class="d">'+dn+'</span></button>'}monthStrip.innerHTML=html;const entries=await storage.get('tdj_entries')||{};const specs=await storage.get('tdj_specs')||[];const checklists=await storage.get('tdj_checklists')||{};const reports=await storage.get('tdj_daily_reports')||{};monthStrip.querySelectorAll('.day-box').forEach(btn=>{const ds=btn.dataset.date;const list=entries[ds]||[];const sc=specs.filter(s=>isDateInRange(ds,s.start,s.end||(s.perma?'9999-12-31':''))).length;const checkData=checklists[ds]||{matin:[],aprem:[],nuit:[]};const totalChecks=checkData.matin.length+checkData.aprem.length+checkData.nuit.length;const totalPossible=CHECKLISTS.matin.length+CHECKLISTS.aprem.length+CHECKLISTS.nuit.length;if(totalChecks===totalPossible&&totalChecks>0)btn.classList.add('completed');else if(totalChecks>0)btn.classList.add('partial');if(reports[ds])btn.classList.add('has-report');if(list.length)btn.insertAdjacentHTML('beforeend','<span class="badge badge-regular">'+list.length+'</span>');if(sc)btn.insertAdjacentHTML('beforeend','<span class="badge badge-special">'+sc+'</span>');btn.addEventListener('click',function(){if(parseYmd(ds)<=new Date()){openReportModal(ds)}selectedDate=ds;renderDay(selectedDate)})})}

document.getElementById('btn-add').addEventListener('click',async function(){if(!await getCurrentUser()){alert('Connectez-vous');return}const d=document.getElementById('entry-date').value||localDateStr(new Date());const t=(document.getElementById('entry-title').value||'').trim();if(!t){alert('Titre requis');return}const entries=await storage.get('tdj_entries')||{};if(!entries[d])entries[d]=[];const u=await getCurrentUser();const item={id:'e_'+Date.now()+'_'+Math.random().toString(36).slice(2,6),done:false,t:Date.now(),title:t,by:u?(u.name||u.username):'Op',createdDate:d,reportCount:0};entries[d].unshift(item);await storage.set('tdj_entries',entries);document.getElementById('entry-title').value='';renderDay(d);buildMonthStrip(currentMonthDate)});

document.getElementById('btn-add-spec').addEventListener('click',async function(){if(!await getCurrentUser()){alert('Connectez-vous');return}const title=(document.getElementById('spec-title').value||'').trim();const desc=(document.getElementById('spec-desc').value||'').trim();const start=document.getElementById('spec-start').value;const end=document.getElementById('spec-end').value;const perma=!!document.getElementById('spec-perma').checked;const selectedRooms=Array.from(document.querySelectorAll('#room-selector input[type=checkbox]:checked')).map(c=>c.value);if(!title||!start){alert('Titre et date de d√©but requis');return}if(!perma&&end&&end<start){alert('La date de fin doit √™tre >= √† la date de d√©but');return}const specs=await storage.get('tdj_specs')||[];const item={id:'s_'+Date.now(),title,desc,start,end:perma?'':end,perma,rooms:selectedRooms};specs.push(item);await storage.set('tdj_specs',specs);document.getElementById('spec-title').value='';document.getElementById('spec-desc').value='';document.getElementById('spec-start').value='';document.getElementById('spec-end').value='';document.getElementById('spec-perma').checked=false;document.querySelectorAll('#room-selector input[type=checkbox]').forEach(c=>{c.checked=false;c.closest('.room-checkbox').classList.remove('selected')});renderEditSpecList();renderSpecs(selectedDate);buildMonthStrip(currentMonthDate);renderRoomsRecap(selectedDate)});

document.getElementById('btn-filter').addEventListener('click',function(){const v=document.getElementById('filter-date').value;if(!v)return;selectedDate=v;renderDay(selectedDate)});
document.getElementById('btn-today').addEventListener('click',function(){selectedDate=localDateStr(new Date());renderDay(selectedDate)});
document.getElementById('btn-print').addEventListener('click',function(){window.print()});
document.getElementById('prev-month').addEventListener('click',function(){currentMonthDate=new Date(currentMonthDate.getFullYear(),currentMonthDate.getMonth()-1,1);buildMonthStrip(currentMonthDate)});
document.getElementById('next-month').addEventListener('click',function(){currentMonthDate=new Date(currentMonthDate.getFullYear(),currentMonthDate.getMonth()+1,1);buildMonthStrip(currentMonthDate)});
document.getElementById('btn-users').addEventListener('click',function(){modal.style.display='flex';renderAuthStatus()});
document.getElementById('btn-close-users').addEventListener('click',function(){modal.style.display='none'});
modal.addEventListener('click',function(e){if(e.target===modal)modal.style.display='none'});
['open-login-1','open-login-2','open-login-3','open-login-4','open-login-important'].forEach(id=>{const el=document.getElementById(id);if(el)el.addEventListener('click',function(){modal.style.display='flex';renderAuthStatus()})});
document.getElementById('btn-login').addEventListener('click',async function(){const u=(document.getElementById('login-username').value||'').trim();const p=(document.getElementById('login-password').value||'').trim();const users=await getUsers();const found=users.find(x=>x.username===u&&x.password===p);if(!found){alert('Identifiants invalides');return}await setCurrentUser({username:found.username,name:found.name||found.username,role:found.role||'user'});document.getElementById('login-username').value='';document.getElementById('login-password').value='';modal.style.display='none'});
document.getElementById('btn-create-user').addEventListener('click',async function(){const me=await getCurrentUser();if(!(me&&me.role==='admin')){alert('Admin requis');return}const u=(document.getElementById('new-username').value||'').trim();const p=(document.getElementById('new-password').value||'').trim();const r=document.getElementById('new-role').value||'user';if(!u||!p){alert('Identifiant et mot de passe requis');return}const users=await getUsers();if(users.some(x=>x.username===u)){alert('Identifiant d√©j√† utilis√©');return}users.push({username:u,password:p,name:u,role:r});await storage.set('tdj_users',users);document.getElementById('new-username').value='';document.getElementById('new-password').value='';document.getElementById('new-role').value='user';renderUsersTable()});
document.getElementById('btn-logout').addEventListener('click',async function(){const cu=await getCurrentUser();if(!cu){alert('Aucun utilisateur connect√©');return}await setCurrentUser(null)});
['tgl-add','tgl-edit','tgl-spec','tgl-history'].forEach(id=>{const btn=document.getElementById(id);const bodyId='body-'+id.replace('tgl-','');const body=document.getElementById(bodyId);if(btn&&body)btn.addEventListener('click',function(){const open=btn.getAttribute('aria-expanded')!=='true';body.classList.toggle('hidden',!open);btn.setAttribute('aria-expanded',String(open));btn.textContent=open?'R√©duire':'D√©ployer'})});
document.querySelectorAll('.tab').forEach(tab=>{tab.addEventListener('click',function(){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));tab.classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));const target=tab.dataset.tab+'-list';document.getElementById(target).classList.remove('hidden')})});

renderAuthStatus();renderDay(selectedDate);buildMonthStrip(currentMonthDate);renderEditSpecList();renderDeletedHistory();
console.log('‚úÖ VERSION 5 - CENTRE DE CONTR√îLE charg√© avec succ√®s !');
});
</script>
</body>
</html>
